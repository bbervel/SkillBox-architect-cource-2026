# 10. Архитектурные опции и обоснование выбора

## 10.1. Архитектурный стиль

### Опция A: Монолитная архитектура
**Описание:** Единое приложение, содержащее всю функциональность: пользователи, тренировки, социальные функции, инвентарь, геймификация, промо и т.д. Развертывается как один блок.

**Плюсы:**
- Простота разработки и развертывания на начальном этапе.
- Меньше накладных расходов на сетевое взаимодействие.
- Упрощённое управление транзакциями и согласованностью данных.
- Легче тестировать интеграционно.

**Минусы:**
- Сложность масштабирования отдельных частей (всё масштабируется целиком).
- Замедление разработки по мере роста (жёсткая связанность, сложность внесения изменений).
- Технологический стек фиксирован (сложно использовать разные языки/БД под задачи).
- Высокий риск регрессии при изменениях.
- Сложность организации работы нескольких распределённых команд.

**Вывод:** Не подходит, так как проект предполагает глобальное масштабирование, множество разнородных функций и распределённые команды разработчиков.

### Опция B: Микросервисная архитектура
**Описание:** Разделение системы на небольшие независимые сервисы по границам предметных областей (User, Workout, Social и т.д.). Каждый сервис развёртывается отдельно, взаимодействует через сеть.

**Плюсы:**
- Независимое масштабирование сервисов.
- Возможность использовать разные технологии для разных задач.
- Параллельная разработка командами (меньше конфликтов).
- Изоляция сбоев (падение одного сервиса не обрушивает всю систему).
- Более простая поддержка и эволюция.

**Минусы:**
- Сложность распределённых систем (сетевое взаимодействие, согласованность данных, отладка).
- Требуется инфраструктура для оркестрации и observability.
- Дополнительные задержки при вызовах.
- Управление транзакциями между сервисами требует паттернов (Saga).

**Вывод:** Оптимальный выбор для нашего проекта с учётом глобального масштабирования, разнородных функций и распределённых команд. Принимаем.

### Опция C: Serverless (FaaS)
**Описание:** Функции как сервис (AWS Lambda, Google Cloud Functions) для реализации бизнес-логики без управления серверами.

**Плюсы:**
- Полное отсутствие забот об инфраструктуре.
- Автоматическое масштабирование до нуля.
- Оплата только за фактическое использование.

**Минусы:**
- Ограничения по времени выполнения (для длительных задач не подходит, например, обработка GPS-треков).
- Холодный старт (латентность).
- Vendor lock-in.
- Сложность организации сложных взаимодействий между функциями.
- Ограниченный набор поддерживаемых языков и версий.

**Вывод:** Может использоваться для отдельных фоновых задач (обработка изображений, отправка уведомлений), но как основной стиль не подходит из-за требований к производительности и длительным операциям. Будет применяться точечно в Integration Service или для обработки событий.

**Итоговое решение:** Основной стиль — микросервисы, с возможным использованием serverless для отдельных задач.

---

## 10.2. Декомпозиция на микросервисы

Рассматривались два подхода:

### Опция A: Декомпозиция по техническим слоям (например, фронт-сервис, бэк-сервис, БД-сервис)
**Минусы:** Слабая связанность бизнес-логики, сложность поддержки, изменения затрагивают много сервисов. Отвергнуто.

### Опция B: Декомпозиция по предметным областям (Domain-Driven Design)
**Плюсы:** Каждый сервис отвечает за конкретную бизнес-способность, что упрощает понимание, развитие и масштабирование. Соответствует принципам микросервисов.

**Вывод:** Принята декомпозиция по бизнес-возможностям: User, Workout, Social, Inventory, Gamification, Promo, Notification, Integration, Analytics. Это позволяет каждой команде владеть полным стеком своего сервиса.

---

## 10.3. Базы данных

### Опция A: Единая реляционная БД для всех сервисов
**Минусы:** Тесная связь сервисов на уровне данных, сложность масштабирования, единая точка отказа. Отвергнуто.

### Опция B: Полиглотное хранение (Polyglot Persistence)
Каждый сервис выбирает БД, оптимальную для своих задач.

**Рассмотренные варианты:**

| Сервис | Предлагаемые БД | Обоснование |
|--------|-----------------|-------------|
| User Service | PostgreSQL | ACID, строгая согласованность, поддержка транзакций для профиля. |
| Workout Service | PostgreSQL + TimescaleDB (для временных рядов), объектное хранилище (GPX-файлы) | Требуется работа с геоданными (PostGIS), временными рядами (пульс, темп) и большими файлами. |
| Social Service | MongoDB (сообщения, лента), Neo4j (граф друзей), Elasticsearch (поиск) | Гибкая схема для сообщений, графовые связи для социального графа, полнотекстовый поиск. |
| Inventory Service | PostgreSQL | Транзакционные данные, целостность. |
| Gamification Service | PostgreSQL (достижения), Redis (лидерборды) | Redis для быстрых рейтингов в реальном времени. |
| Promo Service | PostgreSQL + MongoDB | Транзакционные данные промо и гибкий контент новостей. |
| Notification Service | Kafka (очереди), Redis (временные данные) | Очереди сообщений, временное хранение статусов. |
| Analytics Service | ClickHouse / BigQuery, Kafka | Хранилище для больших объёмов событий, аналитические запросы. |

**Плюсы:**
- Оптимальная производительность и стоимость под каждую задачу.
- Возможность использовать лучшие практики для разных типов данных.
- Слабая связанность сервисов через чёткие API.

**Минусы:**
- Сложность администрирования разных СУБД.
- Необходимость в специалистах по разным технологиям.
- Риск рассинхронизации данных между сервисами (решается через саги и события).

**Вывод:** Принято полиглотное хранение как наиболее соответствующее разнородным требованиям.

---

## 10.4. Коммуникация между сервисами

### Опция A: Только синхронная (HTTP/REST/gRPC)
**Плюсы:** Простота понимания, легко отлаживать.
**Минусы:** Увеличивает связанность, снижает отказоустойчивость, плохо для пиковых нагрузок.

### Опция B: Асинхронная через очереди (Kafka, RabbitMQ) в сочетании с синхронной
**Плюсы:** Слабая связанность, устойчивость к пикам, возможность обработки событий.
**Минусы:** Сложность обеспечения согласованности, eventual consistency.

**Вывод:** Используем гибридный подход:
- Синхронные вызовы (REST/gRPC) для критических операций, требующих немедленного ответа (получение профиля, сохранение тренировки).
- Асинхронные события для уведомлений, обновления рейтингов, аналитики, обновления поисковых индексов.
Это обеспечит баланс между производительностью и надёжностью.

---

## 10.5. Инфраструктура и развертывание

### Контекст: Компания уже использует нескольких облачных провайдеров (multi-cloud), нет единого стандарта.

### Опция A: On-premise (собственные серверы)
**Минусы:** Высокие капитальные затраты, сложность масштабирования, не соответствует текущей стратегии компании. Отвергнуто.

### Опция B: Один облачный провайдер (AWS, GCP или Azure)
**Плюсы:** Упрощение управления, интеграции, возможно снижение затрат за счёт единой экосистемы.
**Минусы:** Vendor lock-in, невозможность использовать лучшие предложения других провайдеров, ограничения по регионам.

### Опция C: Мультиоблачная стратегия
**Плюсы:** Свобода выбора сервисов, географическое покрытие, снижение рисков (если один провайдер упадёт), соответствие data residency (можно хранить данные в регионе с нужным провайдером).
**Минусы:** Сложность управления, сетевая задержка между облаками, необходимость унифицировать инструменты.

**Вывод:** Учитывая существующую практику компании и требования data residency, выбираем мультиоблачный подход с использованием Kubernetes для абстракции от конкретного провайдера. Сервисы будут контейнеризированы и развёрнуты в кластерах K8s у разных провайдеров (AWS, GCP) в зависимости от региона и стоимости.

---

## 10.6. API-дизайн

### Опция A: REST (HTTP)
**Плюсы:** Стандарт, широкая поддержка, простота кэширования, хорошо документируется (OpenAPI).
**Минусы:** Иногда избыточность, множественные запросы для сложных данных.

### Опция B: GraphQL
**Плюсы:** Гибкость запросов, уменьшение числа вызовов, удобно для сложных клиентов.
**Минусы:** Сложность кэширования, риск сложных запросов, нагрузка на сервер.

### Опция C: gRPC
**Плюсы:** Высокая производительность, строгая типизация, поддержка потоковой передачи.
**Минусы:** Сложность отладки, ограниченная поддержка в браузерах (требуется grpc-web).

**Вывод:** Для внешних API (мобильные/веб) выбираем REST как наиболее универсальный и простой, дополненный OpenAPI. Для внутренних сервисов (service-to-service) возможно использование gRPC для высоконагруженных взаимодействий. В будущем можно рассмотреть GraphQL для сложных запросов, но на старте ограничимся REST.

---

## 10.7. Интеграция с внешними системами

### Опция A: Прямые вызовы API внешних систем из сервисов
**Минусы:** Связность, сложность обработки сбоев, дублирование кода.

### Опция B: Выделенный сервис-адаптер (Integration Service)
**Плюсы:** Централизованное управление внешними интеграциями, повторное использование, единая точка для мониторинга и обработки ошибок.
**Минусы:** Дополнительный hop.

**Вывод:** Создаём отдельный Integration Service, который инкапсулирует все взаимодействия с носимыми устройствами, фитнес-платформами, e-commerce и другими приложениями компании. Внутренние сервисы обращаются к нему через API или события.

---

## 10.8. Безопасность и аутентификация

### Опция A: Самописная аутентификация (JWT)
**Плюсы:** Простота, контроль.
**Минусы:** Требуется реализация управления ключами, риск ошибок.

### Опция B: Использование готового Identity Provider (Keycloak, Auth0) + SSO
**Плюсы:** Безопасность, поддержка стандартов (OAuth2, OpenID Connect), интеграция с корпоративными системами.
**Минусы:** Дополнительная инфраструктура, затраты.

**Вывод:** В компании уже есть существующие приложения, требуется единый вход (SSO). Используем централизованный Identity Provider (Keycloak или облачный сервис) с поддержкой OAuth2. API Gateway проверяет JWT-токены, а сервисы доверяют им. Это обеспечит безопасность и совместимость с существующей экосистемой.

---

## 10.9. Мониторинг и наблюдаемость

### Опция A: Базовое логирование и мониторинг на уровне инфраструктуры
**Минусы:** Недостаточно для распределённой системы.

### Опция B: Полный стек наблюдаемости (логи, метрики, трассировка)
**Плюсы:** Позволяет быстро находить проблемы, анализировать производительность.
**Минусы:** Сложность внедрения, дополнительные ресурсы.

**Вывод:** Выбираем полный стек: EFK/ELK для логов, Prometheus + Grafana для метрик, Jaeger для трассировки. Это необходимо для выполнения требований надёжности и быстрого реагирования.

---

## 10.10. Заключение

Рассмотренные архитектурные опции позволили сформировать обоснованную концептуальную архитектуру, которая:
- Ориентирована на микросервисы для гибкости и масштабируемости.
- Использует полиглотное хранение данных.
- Базируется на мультиоблачной инфраструктуре с Kubernetes.
- Обеспечивает наблюдаемость и безопасность.
- Учитывает требования глобального присутствия и соответствия регуляциям.

Принятые решения документируются в последующих ADR и будут детализироваться на следующих этапах.