# Безопасность

## Модель угроз (STRIDE)

| Тип угрозы | Примеры | Меры защиты |
|------------|---------|-------------|
| **Spoofing** (подмена) | Злоумышленник выдаёт себя за другого пользователя | Аутентификация через Keycloak (OAuth2, JWT), MFA, биометрия в мобильных приложениях. |
| **Tampering** (изменение) | Изменение данных тренировки в процессе передачи | TLS для всех внешних и внутренних коммуникаций, подпись JWT, контроль целостности. |
| **Repudiation** (отказ) | Пользователь отрицает совершённое действие | Логирование всех значимых действий (аудит), хранение логов в неизменяемом виде. |
| **Information Disclosure** (разглашение) | Утечка персональных данных | Шифрование данных в покое (AES-256), маскирование PII в логах, строгий контроль доступа, управление согласиями. |
| **Denial of Service** (DoS) | Атака на API Gateway | Rate limiting, облачная защита (AWS Shield, Cloudflare), автомасштабирование. |
| **Elevation of Privilege** (повышение привилегий) | Получение прав администратора | Ролевая модель (RBAC) для внутренних пользователей, проверка прав на уровне сервисов, принцип наименьших привилегий. |

## Аутентификация и авторизация

- **Identity Provider**: Keycloak (или облачный Auth0/Okta). Поддерживает:
  - Регистрацию/вход по email + пароль, социальные сети.
  - SSO с существующими приложениями компании.
  - MFA (опционально).
  - Управление сессиями, logout.
- **API Gateway** проверяет JWT-токены, полученные от Keycloak, и передаёт информацию о пользователе (userId, роли) в заголовках к микросервисам.
- **Микросервисы** доверяют заголовкам от Gateway, но могут выполнять дополнительную проверку прав (например, является ли пользователь администратором группы).
- **Роли**: user, moderator, admin, regional_manager. Права разграничены на уровне API.

## Шифрование

- **В пути**: TLS 1.3 для всех внешних API, mTLS для внутренних сервисов (через сервис-меш).
- **В покое**:
  - Базы данных: шифрование дисков (AWS EBS encryption, GCE PD encryption) или Transparent Data Encryption (TDE).
  - Объектное хранилище: server-side encryption (S3-SSE, GCS encryption).
  - Резервные копии: шифрование перед выгрузкой в удалённое хранилище.
- **Ключи шифрования**: управляются через KMS (AWS KMS, Google Cloud KMS) с ротацией.

## Управление согласиями и приватность (GDPR, CCPA)

- **Сбор согласий**: при регистрации и при изменении настроек пользователь явно соглашается на обработку данных (раздельно для тренировок, геолокации, маркетинга). User Service хранит историю согласий.
- **Право на забвение**: при запросе удаления аккаунта запускается процесс анонимизации (удаление PII, обезличивание тренировок). Все сервисы должны поддерживать удаление данных по запросу (через события `user.deleted`).
- **Право на экспорт данных**: пользователь может запросить выгрузку всех своих данных в машиночитаемом формате (JSON).
- **Data residency**: данные пользователей из EU хранятся только в EU-region кластерах; для других регионов аналогично.

## Аудит и мониторинг безопасности

- **Аудит доступа**: все обращения к PII (просмотр профиля, экспорт) логируются с указанием, кто и когда обращался.
- **Логи безопасности** хранятся в отдельном индексе Elasticsearch с ограниченным доступом.
- **Сканирование уязвимостей**:
  - SAST в CI/CD (SonarQube, Checkmarx).
  - DAST на staging (OWASP ZAP).
  - Регулярное пентестирование (раз в год).
- **SIEM**: интеграция с облачными SIEM (AWS Security Hub, Google Chronicle) для корреляции событий.

## Защита инфраструктуры

- **Сетевая изоляция**: сервисы в приватных подсетях, доступ только через API Gateway.
- **WAF** (Web Application Firewall) на уровне балансировщика для защиты от SQL-инъекций, XSS.
- **Безопасная конфигурация**:
  - Минимальные привилегии для сервисных аккаунтов.
  - Регулярные обновления базовых образов.
  - Сканирование образов контейнеров на уязвимости (Trivy, Clair).
- **Управление секретами**: HashiCorp Vault или Kubernetes Secrets + внешнее шифрование (Sealed Secrets).