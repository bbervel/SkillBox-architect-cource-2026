# 15. Анализ рисков созданной архитектуры и компромиссов

## 15.1. Введение

На этапе детального проектирования был проведён углублённый анализ архитектуры, выявивший ряд рисков, связанных с принятыми техническими решениями, а также компромиссы, на которые пришлось пойти для достижения требуемых атрибутов качества. Данный раздел содержит итоговую оценку этих рисков и описание компромиссов.

## 15.2. Методология оценки рисков

Каждый риск оценивается по двум параметрам:
- **Вероятность (P)**: от 1 (очень низкая) до 5 (очень высокая).
- **Влияние (I)**: от 1 (незначительное) до 5 (критическое).
- **Уровень риска**: P × I (от 1 до 25). Риски с уровнем ≥ 12 требуют обязательных мер митигации.

Для каждого риска определены план митигации и ответственный.

## 15.3. Технические риски

### R‑T1: Сложность обеспечения согласованности данных в распределённой системе

**Описание:** Из-за микросервисной архитектуры и асинхронного взаимодействия данные могут оказаться несогласованными (например, инвентарь не обновился после тренировки, лидерборд показывает устаревшие результаты).

**Вероятность:** 4 (высокая)
**Влияние:** 3 (среднее – недовольство пользователей, некорректные рекомендации)
**Уровень риска:** 12

**Митигация:**
- Использование паттерна Saga для распределённых транзакций (хореография или оркестрация).
- Идемпотентность обработчиков событий.
- Периодическая сверка данных (reconciliation jobs).
- Мониторинг целостности (датчики качества данных).

**Ответственный:** Архитектор, команды разработки.

### R‑T2: Сложность отладки и трассировки запросов в микросервисах

**Описание:** Распределённая система затрудняет поиск источника проблем, особенно при каскадных сбоях.

**Вероятность:** 4 (высокая)
**Влияние:** 4 (высокое – увеличение времени восстановления, MTTR)
**Уровень риска:** 16

**Митигация:**
- Внедрение распределённой трассировки (Jaeger) с correlation ID во всех сервисах.
- Централизованное логирование (EFK) с единым форматом.
- Дашборды и алерты, указывающие на конкретный сервис.

**Ответственный:** DevOps, команды разработки.

### R‑T3: Задержки и сбои при межоблачном взаимодействии

**Описание:** При мультиоблачном развёртывании возможны значительные задержки и перебои связи между облаками, что может повлиять на работу сервисов, требующих синхронного взаимодействия.

**Вероятность:** 3 (средняя)
**Влияние:** 3 (среднее – ухудшение производительности, частичная недоступность)
**Уровень риска:** 9

**Митигация:**
- Минимизация синхронных кросс-облачных вызовов; предпочтение асинхронности и локальным репликам данных.
- Использование VPN/Direct Connect с SLA.
- Кэширование данных на границах облаков.

**Ответственный:** DevOps, сетевая команда.

### R‑T4: Утечка данных через неосторожное логирование

**Описание:** В логи могут попадать персональные данные (PII), что создаёт риск утечки и нарушения GDPR.

**Вероятность:** 3 (средняя)
**Влияние:** 5 (критическое – штрафы, потеря репутации)
**Уровень риска:** 15

**Митигация:**
- Автоматическое маскирование PII в логах на уровне сбора (Fluentd filters).
- Регулярный аудит логов на наличие незамаскированных данных.
- Обучение разработчиков правилам логирования.

**Ответственный:** DevOps, информационная безопасность.

### R‑T5: Недостаточная производительность запросов к временным рядам

**Описание:** С ростом пользователей запросы к TimescaleDB (история пульса, темпа) могут замедляться.

**Вероятность:** 3 (средняя)
**Влияние:** 3 (среднее – ухудшение UX)
**Уровень риска:** 9

**Митигация:**
- Партиционирование по времени и пользователю.
- Агрегация данных (materialized views) для часто запрашиваемых статистик.
- Кэширование агрегатов в Redis.

**Ответственный:** Команда Workout Service, DBA.

### R‑T6: Риск потери данных при сбоях Kafka

**Описание:** При неправильной настройке Kafka (replication factor, acks) возможна потеря событий.

**Вероятность:** 2 (низкая)
**Влияние:** 4 (высокое – потеря аналитики, несогласованность)
**Уровень риска:** 8

**Митигация:**
- Настройка replication factor ≥ 3, min.insync.replicas ≥ 2.
- Использование acks=all для критических продюсеров.
- Мониторинг логов Kafka и отставания consumer’ов.

**Ответственный:** DevOps.

### R‑T7: Уязвимости в цепочке поставок (supply chain)

**Описание:** Использование сторонних библиотек и образов контейнеров может внести уязвимости.

**Вероятность:** 3 (средняя)
**Влияние:** 4 (высокое – компрометация системы)
**Уровень риска:** 12

**Митигация:**
- Регулярное сканирование образов (Trivy, Clair).
- Использование проверенных базовых образов (подписанных).
- Автоматическое обновление зависимостей с учётом CVE.

**Ответственный:** Команды разработки, безопасность.

## 15.4. Бизнес-риски

### R‑B1: Низкая вовлечённость пользователей в социальные функции

**Описание:** Пользователи могут не создавать группы, не общаться, что снизит ценность сообщества.

**Вероятность:** 3 (средняя)
**Влияние:** 4 (высокое – невыполнение бизнес-целей)
**Уровень риска:** 12

**Митигация:**
- Исследования UX перед запуском.
- Внедрение геймификации и поощрений за социальную активность.
- Привлечение амбассадоров для создания первых групп.

**Ответственный:** Продуктовый менеджер, маркетинг.

### R‑B2: Персонализированные промо не дают ожидаемой конверсии

**Описание:** Пользователи могут игнорировать промо или воспринимать их как спам.

**Вероятность:** 3 (средняя)
**Влияние:** 3 (среднее – недополученная прибыль)
**Уровень риска:** 9

**Митигация:**
- A/B тестирование форматов и частоты показа.
- Использование машинного обучения для повышения релевантности.
- Интеграция с программой лояльности.

**Ответственный:** Маркетинг, аналитики.

### R‑B3: Регуляторные изменения в разных странах

**Описание:** Новые законы о данных могут потребовать быстрой адаптации системы.

**Вероятность:** 2 (низкая)
**Влияние:** 5 (критическое – блокировка, штрафы)
**Уровень риска:** 10

**Митигация:**
- Модульная архитектура, позволяющая быстро добавлять региональные правила.
- Мониторинг законодательства (юридический отдел).
- Гибкая система согласий.

**Ответственный:** Юридический отдел, архитектор.

## 15.5. Компромиссы архитектуры

В процессе проектирования пришлось пойти на следующие компромиссы:

### 15.5.1. Eventual consistency против строгой согласованности

**Компромисс:** В большинстве сценариев (обновление инвентаря, начисление опыта) используется асинхронность и конечная согласованность, а не синхронные транзакции. Это обеспечивает масштабируемость и отказоустойчивость, но приводит к задержкам (несколько секунд) в обновлении данных. Для пользователя это приемлемо, так как тренировка уже сохранена, а пробег обуви может обновиться чуть позже.

### 15.5.2. Мультиоблачность против простоты управления

**Компромисс:** Выбор мультиоблачной стратегии даёт свободу и соблюдение data residency, но увеличивает сложность управления, требует больше усилий DevOps и может вызывать задержки межоблачного трафика. Принято решение мириться с этой сложностью ради долгосрочной гибкости и соответствия регуляциям.

### 15.5.3. Полиглотность БД против унификации

**Компромисс:** Использование разных СУБД (PostgreSQL, MongoDB, Neo4j, Redis, ClickHouse) позволяет достичь оптимальной производительности для каждой задачи, но усложняет администрирование, требует широкого спектра компетенций и увеличивает стоимость лицензий (для коммерческих версий). Однако это оправдано требованиями к скорости и гибкости.

### 15.5.4. Детальная наблюдаемость против затрат на хранение

**Компромисс:** Сбор всех логов, метрик и трассировок генерирует огромные объёмы данных, что увеличивает затраты. Принято решение о сэмплировании трассировок (10%), установке TTL для логов (30 дней) и агрегации метрик, чтобы балансировать между наблюдаемостью и стоимостью.

### 15.5.5. Безопасность против производительности

**Компромисс:** Шифрование данных (TLS, шифрование дисков), проверка JWT на каждом запросе, аудит доступа – всё это создаёт дополнительную нагрузку. Однако безопасность является критическим атрибутом, поэтому производительность может немного снижаться. Компенсируется масштабированием и оптимизацией (аппаратное ускорение, кэширование).

### 15.5.6. Функциональная полнота против времени выхода на рынок

**Компромисс:** В MVP (этап 1) включены только базовые функции, чтобы быстрее получить обратную связь. Некоторые возможности (массовые соревнования, видеочаты) отложены на более поздние этапы. Это снижает первоначальную привлекательность для продвинутых пользователей, но позволяет быстрее запуститься.

## 15.6. Оценка остаточных рисков

После применения мер митигации остаточные риски оцениваются как приемлемые (уровень ≤ 8). Наиболее значимыми остаются:
- Сложность отладки (R‑T2) – полностью не устраняется, но управляется инструментами.
- Утечка данных через логи (R‑T4) – снижается маскированием, но требует постоянного контроля.
- Низкая вовлечённость (R‑B1) – требует активной работы продукта и маркетинга.

## 15.7. Заключение

Архитектура содержит ряд компромиссов, осознанно принятых для достижения ключевых атрибутов качества. Выявленные риски находятся под контролем, и для них разработаны планы митигации. Регулярный пересмотр рисков и компромиссов должен проводиться в ходе реализации и эксплуатации системы.